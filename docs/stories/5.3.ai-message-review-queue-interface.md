<!-- Powered by BMADâ„¢ Core -->

# Story 5.3: AI Message Review Queue Interface

## Status
Draft

## Story
**As a** user,
**I want** to review and approve low-confidence AI messages,
**so that** I maintain control over what's sent to prospects.

## Dependencies
- **Story 2.1** (AI Confidence Scoring System) MUST be completed - AI review queue infrastructure and confidence scoring
- **Story 1.6** (Basic AI Conversational Agent) MUST be completed - AI agent workflow and message generation
- **Story 5.2** (Campaign Monitoring Dashboard) SHOULD be completed - Dashboard layout and authentication infrastructure
- **Story 1.3** (AI-Powered Contextual Enrichment) MUST be completed - Enrichment data for context panel display

## Acceptance Criteria
1. Review Queue page with two tabs: "Low Confidence" (score <80%), "VIP Accounts" (all messages)
2. Each item shows: Prospect name/company, AI-generated message, confidence score, enrichment context panel
3. Actions: Approve (send as-is), Edit (inline editor, then send), Reject (don't send, optional note)
4. Bulk actions: "Approve all >75%", "Reject all <60%"
5. Context panel: Side-by-side view of enrichment data (talking points, recent activity) + AI message for validation
6. Notifications: Badge count on dashboard menu, email notification if >10 messages waiting
7. Search/filter: By confidence range, by date added, by prospect name

## Tasks / Subtasks

- [ ] **Task 1: Create Review Queue page structure** (AC: 1, 7)
  - [ ] Create page: `apps/web/src/pages/ReviewQueuePage.tsx`
  - [ ] Create layout with tabs:
    - Tab 1: "Low Confidence" (default active)
    - Tab 2: "VIP Accounts"
    - Use shadcn/ui Tabs component: `import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'`
  - [ ] Implement tab switching logic:
    - State: `const [activeTab, setActiveTab] = useState<'low_confidence' | 'vip'>('low_confidence')`
    - Filter reviews based on active tab
  - [ ] Add route: `apps/web/src/App.tsx`
    - Add route: `<Route path="/review-queue" element={<ReviewQueuePage />} />`
    - Ensure route is protected (requires authentication)

- [ ] **Task 2: Implement review item card component** (AC: 2)
  - [ ] Create component: `apps/web/src/components/organisms/ReviewQueueItem.tsx`
  - [ ] Define props interface:
    ```typescript
    interface ReviewQueueItemProps {
      review: {
        id: string;
        prospect: {
          id: string;
          full_name: string;
          company_name: string;
          job_title?: string;
          is_vip?: boolean;
        };
        proposed_message: string;
        proposed_subject?: string;
        ai_confidence_score: number;
        ai_reasoning?: string;
        channel: 'linkedin' | 'email';
        created_at: string;
        enrichment_data?: {
          talking_points?: string[];
          recent_activity?: string;
          company_insights?: string;
        };
      };
      onApprove: (id: string) => void;
      onEdit: (id: string, editedMessage: string, editedSubject?: string) => void;
      onReject: (id: string, reason?: string) => void;
    }
    ```
  - [ ] Display prospect information:
    - Header: Prospect name, company, job title
    - VIP indicator: Gold crown icon (ðŸ‘‘) if `is_vip = true`
    - Confidence score badge: Color-coded (green if >80, amber if 60-80, red if <60)
  - [ ] Display AI-generated message:
    - Show `proposed_subject` if email channel
    - Show `proposed_message` in formatted text area (read-only initially)
    - Show channel indicator: LinkedIn icon or Email icon
  - [ ] Display confidence reasoning:
    - Expandable section: "Why this needs review" (show `ai_reasoning`)
    - Collapsible with chevron icon

- [ ] **Task 3: Implement inline message editor** (AC: 3)
  - [ ] Create component: `apps/web/src/components/molecules/MessageEditor.tsx`
  - [ ] Implement edit mode toggle:
    - Button: "Edit Message" â†’ switches to edit mode
    - In edit mode: Replace read-only text with editable textarea
    - For email: Show subject line editor as well
  - [ ] Use shadcn/ui Textarea component:
    - `import { Textarea } from '@/components/ui/textarea'`
    - Auto-resize: `rows={4}` with `resize-none`
  - [ ] Add character counter (optional):
    - Show character count for LinkedIn messages (max 300 chars recommended)
    - Show word count for email messages
  - [ ] Save/Cancel buttons:
    - "Save Changes" â†’ calls `onEdit()` with edited content
    - "Cancel" â†’ reverts to read-only mode, discards changes

- [ ] **Task 4: Implement action buttons (Approve/Edit/Reject)** (AC: 3)
  - [ ] Add action buttons to ReviewQueueItem:
    - "Approve" button (primary, green): Calls `onApprove(review.id)`
    - "Edit" button (secondary): Toggles edit mode
    - "Reject" button (destructive, red): Opens reject dialog
  - [ ] Implement approve action:
    - Call API: `POST /api/ai-review-queue/${reviewId}/approve`
    - Show loading state: Disable button, show spinner
    - On success: Remove item from list, show toast notification "Message approved and sent"
    - On error: Show error toast, keep item in list
  - [ ] Implement edit action:
    - Toggle edit mode (see Task 3)
    - On save: Call API: `POST /api/ai-review-queue/${reviewId}/edit` with `{ edited_message, edited_subject? }`
    - Show loading state during save
    - On success: Update item in list, show toast "Message edited and sent"
  - [ ] Implement reject action:
    - Open dialog: `apps/web/src/components/molecules/RejectDialog.tsx`
    - Dialog fields: Optional reason textarea, "Reject" button
    - Call API: `POST /api/ai-review-queue/${reviewId}/reject` with `{ rejection_reason? }`
    - On success: Remove item from list, show toast "Message rejected"

- [ ] **Task 5: Implement bulk actions** (AC: 4)
  - [ ] Add bulk action toolbar above review list:
    - Checkbox: "Select all" (selects all visible items)
    - Individual checkboxes on each ReviewQueueItem
    - Bulk action buttons: "Approve Selected (>75%)", "Reject Selected (<60%)"
  - [ ] Implement bulk approve:
    - Filter selected items with `ai_confidence_score > 75`
    - Call API: `POST /api/ai-review-queue/bulk-approve` with `{ review_ids: string[] }`
    - Show progress: "Approving 5 messages..." with loading spinner
    - On success: Remove approved items from list, show toast "5 messages approved"
  - [ ] Implement bulk reject:
    - Filter selected items with `ai_confidence_score < 60`
    - Call API: `POST /api/ai-review-queue/bulk-reject` with `{ review_ids: string[], reason?: string }`
    - Show progress: "Rejecting 3 messages..." with loading spinner
    - On success: Remove rejected items from list, show toast "3 messages rejected"
  - [ ] Add confirmation dialog for bulk actions:
    - "Are you sure you want to approve/reject X messages?"
    - "Yes, proceed" / "Cancel" buttons

- [ ] **Task 6: Implement enrichment context panel** (AC: 5)
  - [ ] Create component: `apps/web/src/components/organisms/EnrichmentContextPanel.tsx`
  - [ ] Display side-by-side layout:
    - Left side: AI-generated message (from ReviewQueueItem)
    - Right side: Enrichment context panel (collapsible)
  - [ ] Show enrichment data:
    - **Talking Points:** List of talking points (if available)
      - Display as bullet list with icons
      - Highlight if mentioned in AI message
    - **Recent Activity:** Recent company/prospect activity (if available)
      - Display as formatted text block
    - **Company Insights:** Company insights (if available)
      - Display as formatted text block
  - [ ] Add validation indicators:
    - Green checkmark: If AI message references enrichment data
    - Warning icon: If AI message makes unverified claims
    - Info icon: If enrichment data is incomplete
  - [ ] Make panel collapsible:
    - Button: "Show/Hide Context" with chevron icon
    - Default: Expanded on desktop, collapsed on mobile
  - [ ] Fetch enrichment data:
    - Call API: `GET /api/prospects/${prospectId}/enrichment`
    - Cache data in component state
    - Show loading skeleton while fetching

- [ ] **Task 7: Implement notification badge and email alerts** (AC: 6)
  - [ ] Add badge to dashboard navigation:
    - Location: `apps/web/src/components/templates/DashboardLayout.tsx`
    - Badge component: `apps/web/src/components/atoms/NotificationBadge.tsx`
    - Display count: Number of pending reviews
    - Color: Red if count > 10, amber if count > 0, hidden if count = 0
  - [ ] Fetch pending review count:
    - Create hook: `apps/web/src/hooks/usePendingReviewCount.ts`
    - Call API: `GET /api/ai-review-queue?status=pending&count_only=true`
    - Use React Query or SWR for auto-refetching (poll every 30 seconds)
  - [ ] Email notification logic (backend - Story 2.1):
    - **Note:** Email notifications already implemented in Story 2.1 (NotificationService)
    - Verify notification triggers when count > 10
    - Frontend: Display toast if user receives email notification (optional)

- [ ] **Task 8: Implement search and filter functionality** (AC: 7)
  - [ ] Add search bar:
    - Component: `apps/web/src/components/molecules/ReviewQueueSearch.tsx`
    - Input field: Search by prospect name or company name
    - Debounce: 300ms delay before filtering
    - Clear button: "X" icon to clear search
  - [ ] Add filter controls:
    - Confidence range filter: Slider or dropdown
      - Options: "All", "<60%", "60-75%", "75-80%", ">80%"
    - Date filter: Date range picker
      - Options: "Today", "Last 7 days", "Last 30 days", "Custom range"
    - Channel filter: Checkboxes
      - Options: "LinkedIn", "Email", "All"
  - [ ] Implement filtering logic:
    - Filter reviews client-side (if <100 items) or server-side (if >100 items)
    - Update URL query params: `?confidence=60-75&date=last_7_days&channel=linkedin`
    - Preserve filters on page reload
  - [ ] Add sort options:
    - Dropdown: "Newest first", "Oldest first", "Confidence (low to high)", "Confidence (high to low)"
    - Default: "Newest first"

- [ ] **Task 9: Create API hooks for review queue operations** (AC: 1, 3, 4)
  - [ ] Create hook: `apps/web/src/hooks/useReviewQueue.ts`
    - Fetch reviews: `GET /api/ai-review-queue?filter=${activeTab}&status=pending`
    - Return: `{ reviews, isLoading, error, refetch }`
    - Use React Query or SWR for caching and auto-refetching
  - [ ] Create hook: `apps/web/src/hooks/useReviewActions.ts`
    - Approve: `POST /api/ai-review-queue/${id}/approve`
    - Edit: `POST /api/ai-review-queue/${id}/edit`
    - Reject: `POST /api/ai-review-queue/${id}/reject`
    - Bulk approve: `POST /api/ai-review-queue/bulk-approve`
    - Bulk reject: `POST /api/ai-review-queue/bulk-reject`
    - Return: Mutation functions with loading/error states
  - [ ] Add optimistic updates:
    - Remove item from list immediately on approve/reject
    - Revert if API call fails (show error toast)

- [ ] **Task 10: Add mobile responsive design** (AC: 1, 2, 5)
  - [ ] Optimize layout for mobile:
    - Stack context panel below message (not side-by-side)
    - Collapse context panel by default on mobile
    - Full-width action buttons (stack vertically)
    - Hide bulk actions on mobile (show only individual actions)
  - [ ] Test on mobile viewport:
    - Use Tailwind responsive classes: `md:flex-row flex-col`
    - Test touch interactions: Tap to expand/collapse
    - Ensure text is readable (min 16px font size)

- [ ] **Task 11: Generate TypeScript types** (AC: All)
  - [ ] Create types: `apps/web/src/types/review-queue.ts`
    - `ReviewQueueItem` interface (matches API response)
    - `ReviewQueueFilters` interface
    - `ReviewAction` type: `'approve' | 'edit' | 'reject'`
  - [ ] Import from shared package if available:
    - Check `packages/shared/src/types/` for existing types
    - Use shared types if they match requirements

- [ ] **Task 12: Write unit tests** (AC: All)
  - [ ] Create test: `apps/web/tests/unit/components/ReviewQueueItem.test.tsx`
    - Test render: Displays prospect info, message, confidence score
    - Test approve action: Calls onApprove with correct ID
    - Test edit action: Toggles edit mode, saves changes
    - Test reject action: Opens dialog, calls onReject with reason
  - [ ] Create test: `apps/web/tests/unit/components/EnrichmentContextPanel.test.tsx`
    - Test render: Displays enrichment data
    - Test collapse/expand: Toggles visibility
    - Test validation indicators: Shows correct icons
  - [ ] Create test: `apps/web/tests/unit/hooks/useReviewQueue.test.ts`
    - Test fetch: Loads reviews from API
    - Test filtering: Filters by tab (low_confidence vs vip)
    - Test refetch: Updates data on refetch

## Dev Notes

### Architecture Context

**Review Queue Interface:**
- Frontend page for reviewing AI-generated messages with low confidence or VIP accounts
- Two-tab interface: Low Confidence (<80%) and VIP Accounts (all messages)
- Inline editing capability for message modification
- Bulk actions for efficient review workflow
- Enrichment context panel for validation

**Integration with Story 2.1:**
- Uses existing `ai_review_queue` table and API endpoints
- Review endpoints exist at `apps/api/src/routes/ai-review-queue.ts`
- AIReviewService available at `apps/api/src/services/AIReviewService.ts`
- Endpoints: `GET /ai-review-queue`, `POST /ai-review-queue/:id/approve`, `POST /ai-review-queue/:id/edit`, `POST /ai-review-queue/:id/reject`, `POST /ai-review-queue/bulk-approve`, `POST /ai-review-queue/bulk-reject`

**Integration with Story 5.2:**
- Uses dashboard layout and authentication from Story 5.2
- Notification badge integrated into dashboard navigation
- Follows same design system (Tailwind CSS + shadcn/ui)

**Previous Story Insights:**
From Story 2.1: AI review queue infrastructure exists. `ai_review_queue` table has fields: `id`, `prospect_id`, `user_id`, `message_type`, `proposed_subject`, `proposed_message`, `ai_confidence_score`, `ai_reasoning`, `status`, `priority`, `requires_immediate_attention`, `created_at`. Review endpoints support filtering by `status`, `priority`, and prospect `is_vip` flag.

From Story 1.3: Enrichment data available via `GET /api/prospects/:id/enrichment` endpoint. Returns `talking_points`, `recent_activity`, `company_insights`, `company_data`.

From Story 1.6: AI agent workflow generates messages and queues low-confidence messages automatically.

**UI/UX Considerations:**
- Mobile-first responsive design
- Loading states for all async operations
- Error handling with user-friendly messages
- Optimistic updates for better perceived performance
- Keyboard shortcuts (optional): `A` to approve, `E` to edit, `R` to reject

### Testing

**Testing Framework:** Vitest for unit tests, React Testing Library for component tests, Playwright for E2E tests (optional)

**Test Organization:**
- Component tests: `apps/web/tests/unit/components/`
- Hook tests: `apps/web/tests/unit/hooks/`
- Page tests: `apps/web/tests/unit/pages/`

**Test Requirements:**
1. Test review queue page: Renders tabs, loads reviews, filters by tab
2. Test review item: Displays all required information, handles actions
3. Test inline editor: Toggles edit mode, saves changes, validates input
4. Test bulk actions: Selects items, approves/rejects in bulk
5. Test context panel: Displays enrichment data, collapses/expands
6. Test search/filter: Filters reviews by criteria, preserves state
7. Test notifications: Badge updates, email alerts trigger
8. Test mobile responsive: Layout adapts, touch interactions work

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation for Epic 5: Zero-Config Onboarding & Dashboard UX | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
TBD

### Completion Notes
- Story created as part of Epic 5: Zero-Config Onboarding & Dashboard UX
- Implements frontend interface for AI message review queue
- Provides human-in-the-loop control over AI-generated messages
- Integrates with Story 2.1 backend infrastructure
- Supports both low-confidence and VIP account reviews

