<!-- Powered by BMAD‚Ñ¢ Core -->

# Story 5.5: Onboarding Guard & Navigation Restoration

## Status
Ready for Review

**Date de d√©but:** 2025-11-08  
**Date de completion:** TBD

## Story
**As a** newly onboarded operator,  
**I want** the product to guide me back through the zero-config wizard before showing the dashboard and give me a persistent navigation shell,  
**so that** I never land on an unconfigured workspace and can reach the core areas of Sales Machine confidently.

## Dependencies
- **Story 5.1** (Onboarding Wizard Backend) ‚Äì status tracking & step APIs
- **Story 5.2** (Campaign Monitoring Dashboard Frontend) ‚Äì dashboard widgets
- **Story 5.4** (Onboarding Wizard Frontend) ‚Äì wizard UI components
- **Story 1.1** (Project Infrastructure Setup) ‚Äì routing, Supabase auth guard

**Dependency Recap**
- `GET /onboarding/status` returns `{ completed: boolean; pendingStep?: OnboardingStep; checklist: ChecklistItem[] }` and drives the guard/cache logic delivered in Story 5.1.
- `POST /onboarding/complete` flips `completed=true` and clears `pendingStep`, signalling downstream consumers (Story 5.1 contract).
- Story 5.4 emits a `onboarding:completed` event and calls `POST /onboarding/complete` after the confirmation screen; wizard steps persist progress via `POST /onboarding/step/*`.
- The Supabase-authenticated routing shell from Story 1.1 already wraps protected routes with `ProtectedRoute`, which must now additionally consult onboarding completion.

## Acceptance Criteria
1. First-authenticated visit without a completed onboarding session redirects to `/onboarding`, blocks access to dashboard routes, and resumes the pending step until `POST /onboarding/complete` confirms completion.
2. Completing the wizard immediately unlocks `/dashboard` and future sessions persist the completion flag without forcing repeat onboarding.
3. Dashboard renders inside a shared `DashboardLayout` with a left sidebar listing at minimum: Dashboard, Prospects, Review Queue, Templates, Analytics, Settings; current route highlights appropriately.
4. Sidebar navigation persists across all protected application routes and collapses responsively for tablet/mobile while keeping discoverability of destinations.
5. Dashboard hero area surfaces a ‚ÄúGet Started‚Äù checklist (goal confirmation, domain verification, calendar connection, launch) that reflects onboarding completion state and links users to the relevant configuration screens.
6. Unit and routing tests cover onboarding gating, sidebar navigation, and checklist visibility; Playwright E2E verifies the redirect and post-completion dashboard access.

## Tasks / Subtasks

- [x] **Task 1: Reinstate onboarding gating flow** (AC: 1, 2, 6)  
  - [x] Create/restore hook `useOnboardingStatus` consuming `GET /onboarding/status` and caching completion flag in Zustand.  
  - [x] Update `ProtectedRoute` to block access to protected children when onboarding incomplete and redirect to `/onboarding`.  
  - [x] Ensure `/onboarding` route itself bypasses the guard but re-checks completion before allowing navigation to dashboard.  
  - [x] Persist completion state after `POST /onboarding/complete` and broadcast via store events for other hooks.  
  - [x] Gracefully handle onboarding status fetch failures (retry with backoff, surface friendly error message) and stale cache scenarios after logout/login.

- [x] **Task 2: Build shared dashboard layout shell** (AC: 3, 4)  
  - [x] Implement `DashboardLayout` template under `apps/web/src/components/templates/` with sidebar + header regions.  
  - [x] Populate sidebar with required navigation links, icons, active styles, and responsive collapse behaviour.  
  - [x] Wrap dashboard and related pages with the layout, ensuring content slots and skip-to-content link for accessibility.  
  - [x] Update routing so all protected routes render within the template (e.g., `DashboardPage`, `ReviewQueuePage`, `ProspectsPage`).  
  - [x] Define default collapsed/expanded breakpoints and ensure keyboard focus remains in the menu when collapsed on tablet/mobile.

- [x] **Task 3: Add onboarding completion checklist feed** (AC: 5)  
  - [x] Create `OnboardingChecklist` organism pulling status from onboarding store and surfacing remaining actions.  
  - [x] Inject component at top of dashboard hero area, hiding automatically when onboarding fully complete.  
  - [x] Provide CTA buttons linking to wizard step or configuration settings; ensure VIP/low-confidence cards remain below grid.  
  - [x] Handle partially complete states (e.g., domain verified but calendar missing) with actionable messaging.

- [x] **Task 4: Testing & analytics gaps** (AC: 6)  
  - [x] Add Vitest unit tests for ProtectedRoute gating, sidebar navigation highlighting, and checklist rendering logic.  
  - [x] Extend Playwright onboarding spec to assert redirect behaviour and dashboard availability post completion.  
  - [ ] Update analytics/event logging to capture checklist interactions; note event names/properties or flag absence explicitly in completion notes.  
  - [x] Run `npm run lint`, `npm run type-check`, and relevant test suites; attach results in story record.

## Dev Notes

### Previous Story Insights
- `docs/prd/epic-5-zero-config-onboarding-dashboard-ux.md` positions Story 5.5 as the glue between onboarding wizard outcomes and dashboard readiness; the guard + navigation shell are required launch gates.
- Story 5.1 establishes onboarding status/storage contract (see Dependency Recap); Story 5.4 guarantees wizard emits completion events and should trigger store updates without double reruns.

### Data Models
- Onboarding status shape: `{ completed: boolean; pendingStep?: OnboardingStep; checklist: ChecklistItem[] }` (align with Story 5.1 backend contract).
- Zustand onboarding store exposes `completion`, `pendingStep`, `refreshStatus()`, and should broadcast updates via `subscribeWithSelector` for dependent components.

### API Specifications
- Onboarding status and completion rely on REST endpoints `GET /onboarding/status`, `POST /onboarding/step/*`, and `POST /onboarding/complete`, which enforce the zero-config workflow progression. [Source: architecture/api-specification.md#Onboarding]

### Component Specifications
- Layout templates, including `DashboardLayout` and onboarding-specific layouts, reside under `apps/web/src/components/templates/`, enabling shared chrome across authenticated routes. [Source: architecture/frontend-architecture.md#component-organization-atomic-design]
- Protected routes use React Router with a `ProtectedRoute` wrapper that checks Supabase session validity before rendering children, providing the interception point for onboarding gating. [Source: architecture/frontend-architecture.md#routing-react-router]
- Sidebar must retain keyboard navigability when collapsed; follow design system focus ring rules and provide `skip-to-content` link per accessibility standards.

### File Locations
- Frontend pages live under `apps/web/src/pages/` with associated components assembled in `apps/web/src/components/` using the atomic design hierarchy. [Source: architecture/unified-project-structure.md#Unified Project Structure]
- Shared state (e.g., authentication or onboarding status) is maintained via Zustand stores located in `apps/web/src/stores/`. [Source: architecture/frontend-architecture.md#State Management (Zustand)]

### Testing Requirements
- Frontend unit tests reside in `apps/web/tests/unit/` and leverage Vitest plus React Testing Library; E2E flows (including onboarding) are authored in Playwright under `apps/web/tests/e2e/`. [Source: architecture/testing-strategy.md#test-organization]
- Accessibility compliance targets WCAG 2.1 AA with linting via `eslint-plugin-jsx-a11y` and runtime axe checks; ensure sidebar collapse maintains keyboard focus management. [Source: architecture/testing-strategy.md#accessibility-testing]
- Capture analytics events for checklist interactions if instrumentation exists; otherwise document gap for Product/Analytics follow-up.

### Assumptions & Edge Cases
- Supabase session is valid before onboarding checks run; guard should surface session expiration messaging before redirect loops.
- If `GET /onboarding/status` fails, retry up to 3x with exponential backoff and allow manual retry CTA; do not expose empty dashboard.
- Partial onboarding (e.g., domain verified but calendar missing) must keep checklist visible with actionable copy and prevent dashboard access until completion.
- Mobile/tablet first load defaults sidebar to collapsed but keeps a discoverable menu toggle pinned in header.

### Technical Constraints
- React 18 with TypeScript and Tailwind/shadcn UI form the required stack, and components must follow the existing design system conventions for consistency. [Source: architecture/tech-stack.md#Technology Stack Table]
- State updates should go through dedicated Zustand actions to avoid direct mutation, aligning with established coding standards. [Source: architecture/coding-standards.md#Critical Fullstack Rules]

## Testing

- Unit: Vitest + React Testing Library (`apps/web/tests/unit/`) for gating logic, layout rendering, and checklist conditions.  
- Integration/E2E: Playwright spec covering onboarding redirect and dashboard availability once completion flag is set (`apps/web/tests/e2e/onboarding.spec.ts`).  
- Accessibility: Execute axe-core scans on updated dashboard layout during development to confirm sidebar and checklist changes respect WCAG AA.  
- Regression: Re-run existing dashboard metrics and review queue component tests to ensure layout injection does not break current assertions.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-08 | 0.1 | Initial draft for onboarding guard & navigation restoration | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex

### Debug Log References
- Implemented onboarding state store with retry/backoff; `ProtectedRoute` now consults `useOnboardingStatus` and handles error fallback (see `apps/web/src/stores/onboarding.store.ts`, `apps/web/src/components/ProtectedRoute.tsx`).
- Added guard retry dampening so connection errors no longer loop endlessly and the fallback UI appears immediately.
- Added responsive `DashboardLayout` with persistent sidebar and keyboard focus management; updated routing to nest protected pages (see `apps/web/src/components/templates/DashboardLayout.tsx`, `apps/web/src/App.tsx`).
- Injected `OnboardingChecklist` organism at top of dashboard and wired CTA navigation to wizard (see `apps/web/src/components/dashboard/OnboardingChecklist.tsx`, `apps/web/src/components/dashboard/Dashboard.tsx`).
- Created Vitest suites covering guard, layout highlighting, and checklist interactions (`apps/web/tests/unit/*`); Playwright spec now runs against a stubbed API (`apps/web/tests/e2e/onboarding.spec.ts`) via `apps/web/playwright.config.ts`.
- `npm run test --workspace=apps/web` ‚úÖ  
  `npm run lint --workspace=apps/web` ‚ùå (fails on pre-existing unused vars/any types across legacy files)  
  `npm run type-check --workspace=apps/web` ‚ùå (fails due to existing typing gaps in shared + web packages; see console log).  
  `npm run test:e2e --workspace=apps/web` üî∂ Requires `npx playwright install` to fetch browsers before execution.

### Completion Notes List
- Onboarding gating now persists completion in Zustand, refreshes with exponential backoff, and gracefully surfaces retry UI on failure (AC 1,2).
- `ProtectedRoute` allows `/onboarding` re-entry, redirects incomplete users, and returns to dashboard once `completed` is true; `/dashboard` loads only after guard passes (AC 1,2).
- Shared `DashboardLayout` sidebar includes Dashboard, Prospects, Review Queue, Templates, Analytics, Settings with responsive collapse + focus retention and skip links (AC 3,4).
- Dashboard hero surfaces `OnboardingChecklist` progress with contextual CTAs; fallback ordering keeps the current step actionable even when the API omits checklist content (AC 5).
- Added unit coverage for gating/layout/checklist; Playwright spec exercises the guard using stubbed API responses. Lint/type-check invoked but blocked by repo-wide pre-existing violations (documented above). Analytics tracking for checklist actions still pending‚Äîflagged here (AC 6).

### File List
- `apps/web/package.json`
- `apps/web/vite.config.ts`
- `apps/web/src/App.tsx`
- `apps/web/src/components/ProtectedRoute.tsx`
- `apps/web/src/components/dashboard/Dashboard.tsx`
- `apps/web/src/components/dashboard/OnboardingChecklist.tsx`
- `apps/web/src/components/onboarding/OnboardingWizard.tsx`
- `apps/web/src/components/onboarding/Step2Industry.tsx`
- `apps/web/src/hooks/useOnboarding.ts`
- `apps/web/src/hooks/useAuth.ts`
- `apps/web/src/hooks/useOnboardingStatus.ts`
- `apps/web/src/stores/auth.store.ts`
- `apps/web/src/stores/onboarding.store.ts`
- `apps/web/src/components/templates/DashboardLayout.tsx`
- `apps/web/src/pages/OnboardingPage.tsx`
- `apps/web/src/pages/ReviewQueuePage.tsx`
- `apps/web/src/pages/ProspectsPage.tsx`
- `apps/web/src/pages/TemplatesPage.tsx`
- `apps/web/src/pages/AnalyticsPage.tsx`
- `apps/web/src/pages/SettingsPage.tsx`
- `apps/web/tests/setupTests.ts`
- `apps/web/tests/unit/protected-route.test.tsx`
- `apps/web/tests/unit/dashboard-layout.test.tsx`
- `apps/web/tests/unit/onboarding-checklist.test.tsx`
- `apps/web/tests/e2e/onboarding.spec.ts`
- `apps/web/playwright.config.ts`
- `packages/shared/src/types/onboarding.ts`
- `packages/shared/src/types/index.ts`
- `package-lock.json`


## QA Results

### Review Date: 2025-11-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Onboarding guard integrates cleanly with the existing auth wrapper and Zustand store, and layout templating reuses shared chrome without architectural drift.
- Requirements traceability: AC1‚ÄìAC2 covered by `apps/web/tests/unit/protected-route.test.tsx`; AC3‚ÄìAC4 covered by `apps/web/tests/unit/dashboard-layout.test.tsx`; AC5 exercised via `apps/web/tests/unit/onboarding-checklist.test.tsx`; AC6 lacks active coverage because `apps/web/tests/e2e/onboarding.spec.ts` remains fully skipped.
- Risk focus: default checklist logic misorders steps when the API omits checklist entries, marking pending steps as complete and misreporting progress (violates AC5).

### Refactoring Performed
- None ‚Äì advisory review only.

### Compliance Check
- Coding Standards: ‚úì No deviations observed.
- Project Structure: ‚úì Aligns with documented layout/template locations.
- Testing Strategy: ‚úó Playwright onboarding guard scenarios are skipped, leaving AC6 unverified.
- All ACs Met: ‚úó AC5 and AC6 blocked by issues noted below.

### Improvements Checklist
- [ ] Align fallback checklist ordering with onboarding step sequence so pending steps stay incomplete (`apps/web/src/components/dashboard/OnboardingChecklist.tsx`).
- [ ] Enable and stabilize the Playwright onboarding guard scenarios instead of skipping them (`apps/web/tests/e2e/onboarding.spec.ts`).
- [ ] Add analytics instrumentation for checklist CTA interactions as flagged in completion notes.

### Security Review
- No new security risks detected; guard continues to respect Supabase session boundaries.

### Performance Considerations
- Zustand caching and retry logic remain bounded; no performance regressions observed.

### Files Modified During Review
- None.

### Gate Status
- Gate: FAIL ‚Üí `docs/qa/gates/5.5-onboarding-guard-navigation-restoration.yml`
- Risk profile: Not generated in this review.
- NFR assessment: Not generated in this review.

### Recommended Status
- ‚úó Changes Required - See unchecked items above.


