<!-- Powered by BMAD™ Core -->

# Story 1.5.1: Migration Instantly → SMTP Dédié

## Status
Completed ✅

## Dependencies
- **Story 1.4** (Proven Email Template Library) - Templates must be available for email sending
- **Story 1.1** (Project Infrastructure Setup) - Supabase, Upstash Redis configured

## Story
**As a** developer,
**I want** to migrate from Instantly.ai/Smartlead to dedicated SMTP server for email sending,
**so that** I can use the new stack "No Spray No Pray" and have better control over email deliverability.

## Acceptance Criteria
1. **Provider Selection:** SMTP provider selected (SendGrid, Mailgun, or AWS SES) with documented decision and justification
2. **Identification:** All Instantly/Smartlead references identified in codebase (workflows, routes, services, stories, documentation)
3. **Documentation:** Migration document created (`docs/migration/INSTANTLY_TO_SMTP.md`) with configuration, breaking changes, and rollback procedure
4. **SMTPService:** Service created `apps/api/src/services/SMTPService.ts` with methods for sending emails, tracking delivery, and handling bounces
5. **Database Migration:** Migration created for storing SMTP credentials (if not already in `api_credentials` table)
6. **Settings API:** Route `apps/api/src/routes/settings.ts` updated to support SMTP configuration (host, port, user, pass, from address)
7. **N8N Workflow:** Email sending workflows updated to use SMTP instead of Instantly/Smartlead API
8. **Environment Variables:** Update `.env.example` and documentation to replace Instantly/Smartlead variables with SMTP variables
9. **Testing:** Migration tested on development environment with sample emails
10. **Rollback:** Rollback procedure documented and tested (can revert to Instantly if needed)

## Tasks / Subtasks

- [x] **Task 1: Evaluate and select SMTP provider** (AC: 1)
  - [x] Evaluate SendGrid (features, pricing, limits, deliverability)
  - [x] Evaluate Mailgun (features, pricing, limits, deliverability)
  - [x] Evaluate AWS SES (features, pricing, limits, deliverability)
  - [x] Compare features: SMTP support, API support, webhooks, analytics, warm-up support
  - [x] Compare pricing: Cost per email, free tier, monthly limits
  - [x] Compare deliverability: Reputation, IP warming, best practices
  - [x] Create decision document: `docs/decisions/SMTP_PROVIDER_SELECTION.md`
  - [x] Document final decision with justification
  - **Selected:** Mailgun (EU servers for GDPR compliance, €35/month for 50K emails)

- [ ] **Task 2: Identify all Instantly/Smartlead references** (AC: 2)
  - [ ] Search codebase for "Instantly", "instantly", "INSTANTLY"
  - [ ] Search codebase for "Smartlead", "smartlead", "SMARTLEAD"
  - [ ] Search workflows for Instantly/Smartlead references
  - [ ] Search routes/services for Instantly/Smartlead references
  - [ ] Search documentation for Instantly/Smartlead references
  - [ ] Create inventory list: `docs/migration/INSTANTLY_REFERENCES.md`

- [ ] **Task 3: Create migration document** (AC: 3)
  - [ ] Create `docs/migration/INSTANTLY_TO_SMTP.md`
  - [ ] Document Instantly/Smartlead API endpoints used
  - [ ] Document SMTP configuration equivalent
  - [ ] Create mapping table: Instantly endpoint → SMTP equivalent
  - [ ] Document data format differences (request/response)
  - [ ] Document breaking changes
  - [ ] Document email warm-up requirements (2-3 weeks)
  - [ ] Document rollback procedure

- [x] **Task 4: Create SMTPService** (AC: 4)
  - [x] Create `apps/api/src/services/SMTPService.ts` ✅ (exists)
  - [ ] **Install SMTP library:** Add `nodemailer` package to `apps/api/package.json`:
    - Run: `npm install nodemailer @types/nodemailer`
    - Alternative: Use provider-specific SDKs (SendGrid SDK, Mailgun SDK, AWS SES SDK)
  - [ ] Implement `sendEmail(params)` - Send email via SMTP:
    - Parameters: `{ to: string, from: string, subject: string, html: string, text?: string, replyTo?: string, attachments?: Array }`
    - Use nodemailer or provider SDK to send email
    - Return: `{ messageId: string, status: 'sent' | 'failed', error?: string }`
    - Support HTML and plain text versions
  - [ ] Implement `verifyCredentials(smtpConfig)` - Test SMTP connection:
    - Parameters: `{ host, port, user, pass, secure }`
    - Create test SMTP connection and attempt to verify
    - Return: `{ valid: boolean, error?: string }`
  - [ ] Implement `trackDelivery(messageId)` - Track email delivery status:
    - Query SMTP provider API for message status (delivered, bounced, failed)
    - Store status in database or return current status
    - **Note:** Delivery tracking depends on provider webhooks or API polling
  - [ ] Implement `handleBounce(bounceData)` - Handle bounce notifications:
    - Called from webhook endpoint when SMTP provider sends bounce event
    - Update prospect status to 'bounced' or 'invalid_email'
    - Log bounce reason to audit_log
    - Increment bounce counter for user/domain
  - [x] Add error handling: ✅
    - Catch SMTP connection errors (ECONNREFUSED, ETIMEDOUT) ✅
    - Catch authentication errors (invalid credentials) ✅
    - Catch rate limit errors (429 Too Many Requests) ✅
    - Map SMTP errors to standard error format ✅
  - [x] Add retry logic: ✅
    - Retry transient failures (network errors) with exponential backoff (1s, 2s, 4s) ✅
    - Max 3 retries for transient errors ✅
    - Don't retry permanent failures (invalid email, authentication errors) ✅
  - [x] Add rate limiting awareness: ✅
    - Check daily limit (50-100 emails/day per address) before sending ✅
    - Use Upstash Redis counter: `email_limit:{user_id}:{from_email}:{YYYY-MM-DD}` ✅
    - Increment counter after successful send ✅
    - Return 429 error if limit exceeded ✅
  - [x] Support multiple SMTP providers: ✅
    - Abstract provider interface: `SMTPProvider` with `sendEmail()`, `verifyCredentials()`, `handleWebhook()` ✅
    - Implement: `MailgunProvider` (primary) ✅
    - Select provider based on `api_credentials.service_name` or environment variable ✅
  - [x] Reference: See `docs/architecture/backend-architecture.md` lines 73-94 for service structure pattern ✅

- [x] **Task 5: Verify/Update database schema for SMTP** (AC: 5)
  - [x] Check if `api_credentials` table exists (see `supabase/migrations/20251006000001_initial_schema.sql`) ✅
    - Verify table structure: `id`, `user_id`, `service_name`, `api_key`, `webhook_url`, `metadata` (JSONB) ✅
  - [x] **Option 1 (Recommended):** Use existing `api_credentials` table: ✅
    - Store SMTP config in `metadata` JSONB field: `{ host, port, user, pass, from_email, secure, provider }` ✅
    - Set `service_name = 'smtp'` or `'smtp_mailgun'` ✅
    - Store encrypted password in `api_key` field OR in `metadata.pass` (encrypted) ✅
    - Use `webhook_url` field for SMTP provider webhook URL (for bounce/spam notifications) ✅
  - [ ] **Option 2:** If more structure needed, create migration to add SMTP-specific fields:
    - Migration: `supabase/migrations/YYYYMMDD_add_smtp_config.sql`
    - Add fields: `smtp_host`, `smtp_port`, `smtp_user`, `smtp_pass_encrypted`, `smtp_from_email`
    - **Note:** This is likely unnecessary - JSONB metadata is more flexible
  - [ ] Verify RLS policies exist for `api_credentials` table:
    - Policy: `auth.uid() = user_id` (users can only access their own credentials)
  - [ ] Test schema on dev environment:
    - Insert test SMTP credential: `INSERT INTO api_credentials (user_id, service_name, metadata) VALUES (...)`
    - Verify RLS policy prevents access to other users' credentials

- [ ] **Task 6: Update Settings API route** (AC: 6)
  - [ ] Read `apps/api/src/routes/settings.ts` (current implementation lines 7-23)
  - [ ] Update `saveApiCredentialSchema` enum (line 8-19):
    - Remove: `'instantly'`, `'smartlead'` from service names enum
    - Add: `'smtp'` or `'smtp_sendgrid'`, `'smtp_mailgun'`, `'smtp_ses'` (based on provider selection)
  - [ ] Update validation logic for SMTP credentials:
    - If service_name starts with 'smtp', validate `metadata` field contains: `{ host, port, user, pass, from_email, secure? }`
    - Port must be valid (25, 465, 587, 2525)
    - Host must be valid domain
  - [ ] **Note:** SMTP credentials can be stored in `api_credentials` table with `service_name = 'smtp'` and SMTP config in `metadata` JSONB field
  - [ ] Alternatively, create separate SMTP configuration endpoints:
    - `POST /settings/smtp` - Save SMTP configuration (uses api_credentials table)
    - `GET /settings/smtp` - Get SMTP configuration
    - `POST /settings/smtp/verify` - Test SMTP connection (uses SMTPService.verifyCredentials())
  - [ ] Update documentation/comments referencing Instantly/Smartlead

- [ ] **Task 7: Update N8N workflows** (AC: 7)
  - [ ] Identify all N8N workflows that send emails:
    - Search for "instantly" or "smartlead" in workflow JSON files
    - Check `workflows/` directory for email-related workflows
    - Expected workflows: Email scheduler, email reply handler, meeting confirmation emails
  - [ ] Replace Instantly/Smartlead HTTP Request nodes with SMTP nodes:
    - **Option 1:** Use N8N SMTP node (if available) - configure SMTP connection
    - **Option 2:** Use HTTP Request node to call API Gateway endpoint: `POST /api/email/send`
      - This endpoint uses SMTPService internally
      - More secure (credentials stored in database, not in N8N)
    - **Option 3:** Use N8N Code node with nodemailer library (if N8N supports npm packages)
  - [ ] Update email sending logic:
    - Replace Instantly/Smartlead API request body with SMTP email format
    - Map data: `{ to, from, subject, html, text }`
    - Use template personalization from Story 1.4 (EmailTemplateService)
  - [ ] Update error handling:
    - Replace Instantly/Smartlead error codes with SMTP error handling
    - Handle: SMTP connection failures, authentication errors, rate limits
    - Log errors to audit_log table
    - Notify user via webhook if email sending fails
  - [ ] Update webhook configuration:
    - Configure SMTP provider webhooks (SendGrid/Mailgun/SES) to send bounce/spam events to N8N webhook
    - Webhook URL: `{{ $env.N8N_WEBHOOK_URL }}/smtp-events`
    - Process bounce/spam events in N8N workflow
  - [ ] Test workflows in N8N Cloud (dev environment):
    - Test email sending with sample data
    - Test bounce handling via webhook
    - Test error scenarios (invalid credentials, rate limits)

- [ ] **Task 8: Update environment variables** (AC: 8)
  - [ ] Update `.env.example`: Remove `INSTANTLY_API_KEY`, `SMARTLEAD_API_KEY`
  - [ ] Add SMTP variables: `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM`
  - [ ] Update `apps/api/ENV_VARIABLES.md` documentation
  - [ ] Update `docs/dev-setup.md` environment variables table
  - [ ] Update README.md if it references Instantly/Smartlead

- [ ] **Task 9: Test migration** (AC: 9)
  - [ ] Set up SMTP account (SendGrid/Mailgun/SES)
  - [ ] Configure SMTP credentials in development environment
  - [ ] Test SMTPService methods individually (unit tests)
  - [ ] Test email sending with sample emails
  - [ ] Test email warm-up process (2-3 weeks simulation)
  - [ ] Test bounce handling
  - [ ] Test N8N workflows with SMTP
  - [ ] Verify deliverability and inbox placement

- [ ] **Task 10: Document rollback procedure** (AC: 10)
  - [ ] Create `docs/migration/ROLLBACK_INSTANTLY.md`
  - [ ] Document steps to revert to Instantly/Smartlead
  - [ ] Document Git commits to revert
  - [ ] Document N8N workflow revert steps
  - [ ] Document environment variable changes
  - [ ] Test rollback procedure on dev environment

- [ ] **Task 11: Write unit tests** (AC: 9)
  - [ ] Create test: `apps/api/tests/unit/services/smtp.service.test.ts`
  - [ ] Test SMTPService methods (mock SMTP server)
  - [ ] Test error handling
  - [ ] Test rate limiting
  - [ ] Test bounce handling

## Dev Notes

### Architecture Context

**SMTP Provider Options:**
- **SendGrid:** Popular, good deliverability, free tier (100 emails/day), SMTP + API
- **Mailgun:** Developer-friendly, good API, free tier (5,000 emails/month), SMTP + API
- **AWS SES:** Very cheap ($0.10/1000 emails), requires AWS account, SMTP + API, good for high volume

**Instantly/Smartlead API (Current):**
- **Type:** Third-party email service API (REST API)
- **API Endpoints:** 
  - Instantly: `https://api.instantly.ai/api/v1/campaign/add` (or similar)
  - Smartlead: `https://api.smartlead.ai/api/v1/campaigns` (or similar)
- **Authentication:** API key in header (`X-Instantly-API-Key` or `X-Smartlead-API-Key`)
- **Features:** Email sending, tracking, analytics, warm-up automation
- **Pricing:** Subscription-based (monthly fee)
- **Limitations:** Vendor lock-in, less control over deliverability, higher cost at scale
- **Current References:** 
  - `apps/api/src/routes/settings.ts` line 11-12: `'instantly'`, `'smartlead'` in service enum
  - Search codebase for "instantly" or "smartlead" to find all references

**SMTP Dédié (Target):**
- **Type:** Direct SMTP connection (protocol-based) or REST API (provider-specific)
- **Providers:** SendGrid, Mailgun, AWS SES
- **SendGrid:**
  - SMTP: `smtp.sendgrid.net:587` (TLS) or `smtp.sendgrid.net:465` (SSL)
  - API: `https://api.sendgrid.com/v3/mail/send` (REST API, more features)
  - Authentication: API key in header (`Authorization: Bearer {API_KEY}`)
  - Free tier: 100 emails/day
  - Pricing: $19.95/month for 50K emails (or pay-as-you-go)
- **Mailgun:**
  - SMTP: `smtp.mailgun.org:587` (TLS) or `smtp.mailgun.org:465` (SSL)
  - API: `https://api.mailgun.net/v3/{domain}/messages` (REST API)
  - Authentication: API key in header (`Authorization: Basic {base64(user:pass)}`)
  - Free tier: 5,000 emails/month (first 3 months)
  - Pricing: $35/month for 50K emails
- **AWS SES:**
  - SMTP: `email-smtp.{region}.amazonaws.com:587` (TLS)
  - API: AWS SDK for Node.js
  - Authentication: AWS Access Key ID + Secret Access Key
  - Free tier: 62,000 emails/month (if hosted on EC2)
  - Pricing: $0.10 per 1,000 emails (very cheap)
- **Features:** Full control, better deliverability with proper warm-up, cheaper at scale, webhook support (bounce/spam/open/click)
- **Requirements:** 
  - Email warm-up period (2-3 weeks) per FR7
  - Domain verification (SPF, DKIM, DMARC records)
  - Rate limiting enforcement (50-100 emails/day per address per FR6)

**Breaking Changes:**
- Different API (SMTP vs REST API)
- Different authentication (SMTP credentials vs API keys)
- Different error handling
- Requires email warm-up period before production use

**Migration Strategy:**
1. **Evaluate and select SMTP provider:**
   - Compare SendGrid, Mailgun, AWS SES (features, pricing, EU data residency)
   - Document decision in `docs/decisions/SMTP_PROVIDER_SELECTION.md`
   - Create account and obtain SMTP credentials
2. **Create SMTPService with provider abstraction:**
   - Support multiple providers (SendGrid, Mailgun, SES)
   - Use provider-specific SDKs or nodemailer for SMTP protocol
   - Store provider selection in `api_credentials.metadata.provider`
3. **Update Settings API:**
   - Remove `'instantly'` and `'smartlead'` from service enum
   - Add `'smtp'` service with validation
   - Create SMTP configuration endpoints
4. **Update N8N workflows:**
   - Replace Instantly/Smartlead HTTP Request nodes with SMTP nodes or API Gateway calls
   - Update error handling for SMTP-specific errors
   - Configure webhooks for bounce/spam events
5. **Configure email warm-up:**
   - Plan 2-3 weeks warm-up period before production
   - Start with 5-10 emails/day, gradually increase to 50-100/day
   - Monitor deliverability metrics (bounce rate, spam complaints)
6. **Test thoroughly on dev environment:**
   - Unit tests for SMTPService
   - Integration tests with actual SMTP provider (test account)
   - Test bounce handling, webhook processing
   - Test rate limiting enforcement
7. **Deploy to production:**
   - Update environment variables
   - Deploy updated workflows
   - Monitor for errors in first 24-48 hours
   - Remove Instantly/Smartlead code after validation (1 week post-deployment)

**Rollback Strategy:**
- Keep Instantly/Smartlead code in Git history
- Revert commits if needed
- Revert N8N workflow deployment
- Switch back environment variables

### Testing

**Testing Framework:** Vitest for unit tests, manual testing for N8N workflows and email sending

**Test Organization:**
- Service tests: `apps/api/tests/unit/services/smtp.service.test.ts`
- Integration tests: Manual email sending tests

**Test Requirements:**
1. Test SMTPService method coverage:
   - Test `sendEmail()` with valid SMTP credentials (mock SMTP server or test account)
   - Test `verifyCredentials()` with valid/invalid credentials
   - Test `trackDelivery()` with mock message IDs
   - Test `handleBounce()` with sample bounce data
2. Test error handling:
   - Test SMTP connection failures (ECONNREFUSED, ETIMEDOUT)
   - Test authentication errors (invalid credentials)
   - Test rate limit errors (429 Too Many Requests)
   - Test retry logic for transient failures (network errors)
   - Test no retry for permanent failures (invalid email)
3. Test rate limiting:
   - Test daily limit enforcement (50-100 emails/day per address)
   - Test Redis counter increment: `email_limit:{user_id}:{from_email}:{YYYY-MM-DD}`
   - Test 429 error when limit exceeded
   - Test TTL (24 hours) expiration
4. Test email format validation:
   - Test valid email addresses (should pass)
   - Test invalid email addresses (should fail validation)
   - Test HTML and plain text versions
   - Test special characters in subject/body
5. Test bounce handling:
   - Test webhook endpoint receives bounce events from SMTP provider
   - Test bounce processing updates prospect status
   - Test bounce counter increment
   - Test auto-pause trigger when bounce rate >5%
6. Test provider abstraction:
   - Test SendGrid provider implementation
   - Test Mailgun provider implementation
   - Test SES provider implementation
   - Test provider selection based on configuration
7. Test Settings API integration:
   - Test SMTP credential storage in `api_credentials` table
   - Test SMTP configuration validation
   - Test SMTP connection verification endpoint
8. Test N8N workflow integration:
   - Test email sending via N8N workflow (mock SMTP)
   - Test error handling in workflow
   - Test webhook processing for bounce events

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | Initial story creation for migration | PM Agent |
| 2025-01-11 | 1.1 | Story refinement: Added dependency on Story 1.4, detailed SMTP provider information, improved implementation steps, enhanced test scenarios, corrected database schema references | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
TBD

### Completion Notes
- Story créée pour résoudre CRITICAL 2 du Master Checklist
- Doit être complétée AVANT Story 1.5
- Bloque le développement de Story 1.5 si non résolu
- Email warm-up period (2-3 weeks) doit être planifié

