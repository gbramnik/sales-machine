<!-- Powered by BMAD™ Core -->

# Story 6.4: Operational Runbooks

## Status
Ready for Implementation

**Date de début:** TBD
**Date de completion:** TBD

## Story
**As a** solo-preneur,
**I want** step-by-step troubleshooting guides,
**so that** I can quickly resolve common issues without research.

## Dependencies
- **Story 6.1** (Application Monitoring & Alerting) - Monitoring tools for diagnosis
- **Story 1.5** (Email Campaign Infrastructure) - Email infrastructure context
- **Story 1.6** (Basic AI Conversational Agent) - N8N workflow context
- **Story 5.1** (Onboarding Wizard Backend) - Onboarding context

## Acceptance Criteria
1. Runbook created for: Deliverability degradation (bounce rate spike, spam complaints)
2. Runbook created for: N8N workflow failures (UniPil errors, Claude API timeouts)
3. Runbook created for: User onboarding issues (domain verification fails, calendar connection errors)
4. Runbook created for: Database performance degradation (slow queries, connection pool exhausted)
5. Runbook format: Problem → Diagnosis steps → Resolution steps → Prevention
6. Stored in /docs/runbooks/ with searchable index
7. Test runbooks: Simulate each issue in staging, validate resolution steps work

## Tasks / Subtasks

- [ ] **Task 1: Create runbook directory structure** (AC: 6)
  - [ ] **Verify directory structure:**
    - [ ] Check if `docs/runbooks/` directory exists
    - [ ] If exists: Review existing structure and files
    - [ ] If not exists: Create directory structure
    - [ ] Create subdirectories only if they don't exist:
      - `docs/runbooks/email/`
      - `docs/runbooks/workflows/`
      - `docs/runbooks/onboarding/`
      - `docs/runbooks/database/`
      - `docs/runbooks/monitoring/`
  - [ ] Create runbook template: `docs/runbooks/template.md`
    - Format: Problem → Diagnosis → Resolution → Prevention
    - Include sections: Title, Problem Description, Symptoms, Diagnosis Steps, Resolution Steps, Prevention, Related Runbooks
    - **Template structure:**
      - Frontmatter (YAML): `title`, `category`, `keywords`, `last_updated`
      - Sections: Problem, Symptoms, Diagnosis Steps, Resolution Steps, Prevention, Related Runbooks
      - Format: Markdown with code blocks for commands, numbered lists for steps
    - **Example frontmatter:**
      ```yaml
      ---
      title: "Runbook Title"
      category: "email|workflows|onboarding|database|monitoring"
      keywords: ["keyword1", "keyword2"]
      last_updated: "2025-01-17"
      ---
      ```
  - [ ] Create runbook index: `docs/runbooks/README.md`
    - List all runbooks
    - Categorize by issue type
    - Add search functionality (markdown links)
  - [ ] Create runbook categories:
    - `docs/runbooks/email/` - Email-related issues
    - `docs/runbooks/workflows/` - N8N workflow issues
    - `docs/runbooks/onboarding/` - User onboarding issues
    - `docs/runbooks/database/` - Database issues
    - `docs/runbooks/monitoring/` - Monitoring and alerting issues

- [ ] **Task 2: Create runbook for deliverability degradation** (AC: 1)
  - [ ] Create runbook file: `docs/runbooks/email/deliverability-degradation.md`
  - [ ] Define problem:
    - **Problem:** Email deliverability drops (bounce rate spike, spam complaints, low open rates)
    - **Symptoms:**
      - Bounce rate > 5% (normal: < 2%)
      - Spam complaints > 0.1% (normal: < 0.1%)
      - Open rate drops significantly
      - Emails landing in spam folder
  - [ ] Define diagnosis steps:
    1. Check deliverability health dashboard (if exists)
    2. Review bounce rate in email provider dashboard (Mailgun - primary provider, or SendGrid/SES if configured)
    3. Check spam complaint rate in email provider dashboard
    4. Review recent email content for spam triggers (spam words, excessive links, etc.)
    5. Check sender reputation (if available)
    6. Review domain authentication (SPF, DKIM, DMARC records)
    7. Check for blacklist status (MXToolbox, etc.)
  - [ ] Define resolution steps:
    1. **Immediate actions:**
       - Pause email campaigns if bounce rate > 10%
       - Remove bounced email addresses from prospect list
       - Review and fix domain authentication (SPF, DKIM, DMARC)
    2. **Short-term actions:**
       - Clean email list (remove invalid emails, unsubscribes)
       - Review email content (remove spam triggers)
       - Warm up new sending domain (if domain changed)
       - Contact email provider support for reputation review (Mailgun support: support@mailgun.com)
    3. **Long-term actions:**
       - Implement double opt-in for email collection
       - Improve email content quality (personalization, relevance)
       - Monitor deliverability metrics daily
       - Set up alerts for bounce rate spikes (Story 6.1)
  - [ ] Define prevention:
    - Monitor deliverability metrics daily
    - Set up alerts for bounce rate > 5% and spam complaints > 0.1%
    - Regularly clean email list (remove bounces, unsubscribes)
    - Maintain domain authentication (SPF, DKIM, DMARC)
    - Follow email best practices (personalization, relevance, timing)
  - [ ] Add related runbooks:
    - Link to email infrastructure runbook (if exists)
    - Link to monitoring runbook (Story 6.1)
  - [ ] Test runbook:
    - Simulate bounce rate spike in staging
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved

- [ ] **Task 3: Create runbook for N8N workflow failures** (AC: 2)
  - [ ] Create runbook file: `docs/runbooks/workflows/n8n-workflow-failures.md`
  - [ ] Define problem:
    - **Problem:** N8N workflows failing (UniPil errors, Claude API timeouts, webhook errors)
    - **Symptoms:**
      - Workflow execution failures in N8N dashboard
      - Error notifications in Slack (from Story 6.1)
      - Prospects not being processed
      - AI enrichment not completing
  - [ ] Define diagnosis steps:
    1. Check N8N execution logs for failed workflows
    2. Identify error type:
       - UniPil errors (API rate limits, authentication, LinkedIn API errors, etc.)
       - Claude API timeouts (rate limits, API errors, etc.)
       - Webhook errors (authentication, payload format, etc.)
       - Database errors (connection, query, etc.)
    3. Check error frequency (isolated vs. systematic)
    4. Review workflow configuration (credentials, API keys, etc.)
    5. Check external service status (UniPil API, Claude API, etc.)
    6. Review workflow execution history for patterns
  - [ ] Define resolution steps:
    1. **UniPil errors:**
       - Check UniPil API status (if status page available)
       - Verify API credentials (refresh if expired)
       - Check rate limits (reduce concurrent workflows if needed)
       - Review UniPil error message for specific issue
       - Check UniPilService implementation for error handling
       - Retry failed workflow execution
       - **Note:** UniPil API errors may include: authentication failures, rate limit exceeded, LinkedIn API errors, connection timeouts
    2. **Claude API timeouts:**
       - Check Claude API status
       - Verify API key (refresh if expired)
       - Check rate limits (implement retry logic with exponential backoff)
       - Reduce request size (split large requests)
       - Increase timeout settings (if applicable)
    3. **Webhook errors:**
       - Verify webhook URL is correct
       - Check webhook authentication (API key, signature, etc.)
       - Verify webhook payload format matches expected format
       - Test webhook manually (Postman, curl)
       - Review webhook provider status
    4. **Database errors:**
       - Check database connection (Supabase status)
       - Verify database credentials
       - Review query performance (slow queries)
       - Check database connection pool (exhausted pool)
       - Review database error logs
    5. **General resolution:**
       - Retry failed workflow execution
       - Fix workflow configuration if needed
       - Update workflow with error handling
       - Monitor workflow execution after fix
  - [ ] Define prevention:
    - Set up workflow failure alerts (Story 6.1)
    - Implement retry logic in workflows (exponential backoff)
    - Monitor external service status (UniPil API, Claude API)
    - Regularly review workflow execution logs
    - Test workflows after configuration changes
    - Implement error handling in workflows
  - [ ] Add related runbooks:
    - Link to database performance runbook (Task 4)
    - Link to monitoring runbook (Story 6.1)
  - [ ] Test runbook:
    - Simulate UniPil error in staging
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved
    - Repeat for Claude API timeout, webhook error, database error

- [ ] **Task 4: Create runbook for user onboarding issues** (AC: 3)
  - [ ] Create runbook file: `docs/runbooks/onboarding/user-onboarding-issues.md`
  - [ ] Define problem:
    - **Problem:** User onboarding fails (domain verification fails, calendar connection errors, OAuth errors)
    - **Symptoms:**
      - User cannot complete onboarding
      - Domain verification fails
      - Calendar connection fails (OAuth error)
      - User reports onboarding issues
  - [ ] Define diagnosis steps:
    1. Check user onboarding status in database
    2. Review onboarding logs (if available)
    3. Identify failure point:
       - Domain verification step
       - Calendar connection step (OAuth)
       - Email configuration step
       - Other onboarding steps
    4. Check domain verification:
       - Verify DNS records (SPF, DKIM, DMARC)
       - Check domain verification API response
       - Review domain verification error message
    5. Check calendar connection:
       - Verify OAuth provider status (Google Calendar, Outlook)
       - Check OAuth credentials (client ID, secret)
       - Review OAuth error message
       - Check OAuth callback URL
    6. Check user account status:
       - Verify user account exists
       - Check user permissions
       - Review user error logs
  - [ ] Define resolution steps:
    1. **Domain verification fails:**
       - Verify DNS records are correct (SPF, DKIM, DMARC)
       - Check domain verification API (test manually)
       - Guide user to fix DNS records (provide instructions)
       - Retry domain verification after DNS update
       - If persistent: Contact domain provider support
    2. **Calendar connection fails:**
       - Verify OAuth provider status (Google Calendar, Outlook)
       - Check OAuth credentials (refresh if needed)
       - Verify OAuth callback URL is correct
       - Guide user to re-authorize calendar connection
       - Clear OAuth tokens and retry connection
       - If persistent: Check OAuth provider error logs
    3. **Email configuration fails:**
      - Verify SMTP credentials (username, password, host, port)
      - Test SMTP connection manually
      - Check email provider status (Mailgun - primary provider, or SendGrid/SES if configured)
      - **Mailgun SMTP:** `smtp.eu.mailgun.org:587` (STARTTLS) or `smtp.eu.mailgun.org:465` (SSL)
      - Guide user to verify SMTP settings
      - Retry email configuration
    4. **General resolution:**
       - Reset user onboarding status (if needed)
       - Guide user through onboarding again
       - Monitor onboarding completion
       - Escalate to support if persistent
  - [ ] Define prevention:
    - Improve onboarding error messages (user-friendly)
    - Add onboarding progress tracking
    - Implement onboarding retry logic
    - Test onboarding flow regularly
    - Monitor onboarding completion rate
    - Set up alerts for onboarding failures
  - [ ] Add related runbooks:
    - Link to deliverability runbook (Task 2)
    - Link to monitoring runbook (Story 6.1)
  - [ ] Test runbook:
    - Simulate domain verification failure in staging
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved
    - Repeat for calendar connection error, email configuration error

- [ ] **Task 5: Create runbook for database performance degradation** (AC: 4)
  - [ ] Create runbook file: `docs/runbooks/database/performance-degradation.md`
  - [ ] Define problem:
    - **Problem:** Database performance degrades (slow queries, connection pool exhausted, high CPU/memory usage)
    - **Symptoms:**
      - API response times increase (> 500ms p95)
      - Database queries timeout
      - Connection pool exhausted errors
      - High database CPU/memory usage
      - Slow dashboard loading
  - [ ] Define diagnosis steps:
    1. Check database performance metrics (Supabase dashboard):
       - CPU usage
       - Memory usage
       - Connection pool usage
       - Query performance (slow queries)
    2. Review slow query logs:
       - Identify queries with high execution time (> 100ms)
       - Check query frequency
       - Review query execution plans
    3. Check connection pool:
       - Verify connection pool size
       - Check active connections
       - Review connection pool exhaustion errors
    4. Check database indexes:
       - Verify indexes exist on frequently queried fields
       - Check index usage (unused indexes)
       - Review index performance
    5. Check database size:
       - Verify database size (storage usage)
       - Check table sizes
       - Review data growth trends
    6. Check for database locks:
       - Review lock contention
       - Check for long-running transactions
       - Review deadlock logs
  - [ ] Define resolution steps:
    1. **Immediate actions:**
       - Increase connection pool size (if exhausted)
       - Kill long-running queries (if blocking)
       - Restart database (if severe performance issues)
    2. **Short-term actions:**
       - Add missing indexes (see Story 6.3, Task 6)
       - Optimize slow queries (rewrite queries, add indexes)
       - Remove unused indexes
       - Analyze and vacuum database (PostgreSQL maintenance)
    3. **Long-term actions:**
       - Implement query caching (Redis)
       - Optimize database schema (normalize, denormalize as needed)
       - Implement database connection pooling (PgBouncer)
       - Scale database (upgrade plan, read replicas)
       - Implement database monitoring (Story 6.1)
    4. **Query optimization:**
       - Review query execution plans
       - Add indexes on frequently queried fields
       - Optimize JOIN operations
       - Use query hints (if needed)
       - Implement pagination for large result sets
  - [ ] Define prevention:
    - Monitor database performance metrics daily
    - Set up alerts for slow queries (> 500ms)
    - Set up alerts for connection pool exhaustion
    - Regularly review and optimize queries
    - Implement database indexing strategy (Story 6.3)
    - Regularly analyze and vacuum database
    - Monitor database size and growth
  - [ ] Add related runbooks:
    - Link to load testing runbook (Story 6.3)
    - Link to monitoring runbook (Story 6.1)
  - [ ] Test runbook:
    - Simulate slow query in staging
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved
    - Repeat for connection pool exhaustion, high CPU usage

- [ ] **Task 6: Create runbook index and search** (AC: 6)
  - [ ] Update runbook index: `docs/runbooks/README.md`
    - Add table of contents
    - Categorize runbooks by issue type
    - Add quick links to each runbook
    - Add search keywords for each runbook
  - [ ] Create runbook categories:
    - **Email Issues:**
      - Deliverability degradation
      - Email sending failures
      - SMTP configuration issues
    - **Workflow Issues:**
      - N8N workflow failures
      - UniPil errors (LinkedIn automation)
      - Claude API timeouts
    - **Onboarding Issues:**
      - User onboarding failures
      - Domain verification issues
      - Calendar connection errors
    - **Database Issues:**
      - Performance degradation
      - Connection pool exhaustion
      - Slow queries
    - **Monitoring Issues:**
      - Alert configuration
      - Monitoring tool setup
  - [ ] Add search functionality:
    - Add keywords to each runbook (frontmatter or metadata)
    - Create search index (markdown-based)
    - Add search instructions to README
  - [ ] Test runbook index:
    - Verify all runbooks listed
    - Verify links work
    - Verify search functionality works

- [ ] **Task 7: Test all runbooks in staging** (AC: 7)
  - [ ] **Set up staging environment (if not exists):**
    - [ ] Verify staging environment exists:
      - Staging API URL: `https://api-staging.sales-machine.com` (or equivalent)
      - Staging Supabase project (separate from production)
      - Staging N8N workspace (or use production with test workflows)
    - [ ] If staging doesn't exist:
      - Create staging Supabase project
      - Deploy staging API instance
      - Configure staging environment variables
      - Run database migrations on staging
    - [ ] Document staging environment URLs and credentials
    - [ ] **Note:** Runbook tests should NEVER run against production
  - [ ] Test deliverability degradation runbook:
    - Simulate bounce rate spike
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved
    - Document test results
  - [ ] Test N8N workflow failures runbook:
    - Simulate UniPil error
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved
    - Document test results
    - Repeat for Claude API timeout, webhook error, database error
  - [ ] Test user onboarding issues runbook:
    - Simulate domain verification failure
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved
    - Document test results
    - Repeat for calendar connection error, email configuration error
  - [ ] Test database performance degradation runbook:
    - Simulate slow query
    - Follow diagnosis steps
    - Follow resolution steps
    - Verify issue resolved
    - Document test results
    - Repeat for connection pool exhaustion, high CPU usage
  - [ ] Update runbooks based on test results:
    - Fix any incorrect steps
    - Add missing steps
    - Improve clarity
    - Add screenshots or examples (if helpful)
  - [ ] Create test results document: `docs/runbooks/test-results.md`
    - Document test scenarios
    - Document test results
    - Document runbook updates

## Dev Notes

### Architecture Context

**Operational Runbooks Purpose:**
Step-by-step troubleshooting guides for solo-preneur to quickly resolve common issues without research. Format: Problem → Diagnosis → Resolution → Prevention.
[Source: docs/prd/epic-6-production-readiness-scale-prep.md#story-64]

**Common Issues to Document:**
Deliverability degradation (bounce rate spike, spam complaints), N8N workflow failures (UniPil errors, Claude API timeouts), User onboarding issues (domain verification fails, calendar connection errors), Database performance degradation (slow queries, connection pool exhausted).
[Source: docs/prd/epic-6-production-readiness-scale-prep.md#story-64]

**Monitoring Tools:**
Use monitoring tools from Story 6.1 for diagnosis: Sentry (error tracking), Betterstack (uptime monitoring), Slack alerts, N8N execution logs, Supabase dashboard.
[Source: docs/stories/6.1.application-monitoring-alerting.md]

**Email Infrastructure:**
SMTP service (Mailgun - primary provider, selected in Story 1.5.1, or SendGrid/SES if configured), domain authentication (SPF, DKIM, DMARC), email provider dashboards for deliverability metrics.
[Source: docs/stories/1.5.email-campaign-infrastructure.md, docs/decisions/SMTP_PROVIDER_SELECTION.md]

**N8N Workflows:**
N8N workflow execution, UniPil integration (replaced PhantomBuster), Claude API integration, webhook configuration, error handling.
[Source: docs/stories/1.6.basic-ai-conversational-agent.md, docs/stories/1.2.1.migration-phantombuster-to-unipil.md]

**Database:**
Supabase PostgreSQL, connection pooling, query performance, indexes, database monitoring.
[Source: docs/architecture/tech-stack.md]

**Project Structure:**
Runbooks: `docs/runbooks/*.md`. Runbook index: `docs/runbooks/README.md`. Runbook test results: `docs/runbooks/test-results.md`.
[Source: architecture/unified-project-structure.md]

### Testing

**Test File Location:**
- Runbook test results: `docs/runbooks/test-results.md`
- Runbook tests: Manual testing in staging environment

**Testing Standards:**
- Test each runbook in staging environment
- Simulate actual issues (don't use production)
- Follow runbook steps exactly
- Document test results
- Update runbooks based on test results

**Testing Process:**
1. Set up staging environment
2. Simulate issue
3. Follow runbook diagnosis steps
4. Follow runbook resolution steps
5. Verify issue resolved
6. Document test results
7. Update runbook if needed

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| TBD | 1.0 | Initial story creation | Sarah (PO) |
| 2025-01-17 | 1.1 | Story corrections: Replaced PhantomBuster references with UniPil, clarified Mailgun as primary email provider, added staging environment verification, added directory existence checks, specified runbook template format | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes List
TBD

### File List
TBD

## QA Results
TBD

