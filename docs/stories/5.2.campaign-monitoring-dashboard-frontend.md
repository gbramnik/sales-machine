<!-- Powered by BMADâ„¢ Core -->

# Story 5.2: Campaign Monitoring Dashboard (Frontend)

## Status
Draft

## Story
**As a** user,
**I want** a visual dashboard showing campaign health,
**so that** I can monitor performance without reading spreadsheets.

## Dependencies
- **Story 1.1** (Project Infrastructure Setup) MUST be completed - Supabase, React setup, authentication
- **Story 1.8** (Basic Reporting & Metrics) MUST be completed - Dashboard API endpoints and health score calculation
- **Story 2.1** (AI Confidence Scoring System) SHOULD be completed - Confidence scores for display
- **Story 1.7** (Meeting Booking Integration) SHOULD be completed - Meeting data for pipeline

## Acceptance Criteria
1. React dashboard with Tailwind CSS + shadcn/ui components
2. Health Score Card: 0-100 score synthesizing deliverability (40%), response rate (30%), AI performance (30%)
3. Meeting Pipeline: Kanban board with columns: Contacted â†’ Engaged â†’ Qualified â†’ Meeting Booked (drag-drop optional)
4. AI Activity Stream: Real-time feed using Supabase Realtime (e.g., "AI qualified [Sarah Chen] - Confidence: 92%")
5. Alert Center: Notifications for deliverability issues, VIP accounts needing review, meetings booked
6. Mobile responsive: Dashboard viewable on phone (read-only, no editing)
7. Authentication: Supabase Auth session validation, redirect to login if unauthorized

## Tasks / Subtasks

- [ ] **Task 1: Set up dashboard page structure** (AC: 1, 7)
  - [ ] Create page: `apps/web/src/pages/DashboardPage.tsx`
  - [ ] Create layout component: `apps/web/src/components/templates/DashboardLayout.tsx`
    - Header: Logo, user menu, navigation
    - Main content area: Grid layout for dashboard cards
    - Sidebar (optional): Navigation menu
  - [ ] Implement authentication check:
    - Create hook: `apps/web/src/hooks/useAuth.ts`
    - Check Supabase session: `const { data: { session } } = await supabase.auth.getSession()`
    - If no session: Redirect to `/login` using React Router `useNavigate()`
    - Store session in Zustand store: `useAuthStore.setState({ session, user: session.user })`
  - [ ] Create route: `apps/web/src/App.tsx`
    - Add route: `<Route path="/dashboard" element={<DashboardPage />} />`
    - Wrap with ProtectedRoute component: `<Route element={<ProtectedRoute />}>...</Route>`
  - [ ] Create ProtectedRoute component: `apps/web/src/components/ProtectedRoute.tsx`
    - Check authentication: Use `useAuth()` hook
    - If authenticated: Render `<Outlet />`
    - If not authenticated: Redirect to `/login`

- [ ] **Task 2: Implement Health Score Card component** (AC: 2)
  - [ ] **Note:** Component already exists at `apps/web/src/components/HealthScoreCard.tsx` - Review and enhance if needed
  - [ ] Verify component props match requirements:
    - `score: number` (0-100)
    - `trend?: 'up' | 'down' | 'stable'`
    - `trendValue?: number`
    - `breakdown?: { deliverability: number, responseRate: number, aiPerformance: number }`
  - [ ] Enhance component if needed:
    - Circular progress ring (120px diameter) with color coding:
      - 90-100: Green (#10B981)
      - 70-89: Amber (#F59E0B)
      - 0-69: Red (#EF4444)
    - Score display: 36px bold monospace font
    - Trend indicator: Arrow icon + percentage change
    - Expandable breakdown: Small bar charts showing 3 sub-scores
    - Accessibility: `role="meter"` with ARIA attributes
  - [ ] Create API hook: `apps/web/src/hooks/useDashboardStats.ts`
    - Fetch from API: `GET /api/dashboard/stats`
    - Use React Query or SWR for caching and refetching
    - Return: `{ healthScore, pipeline, pendingReviews, ... }`
  - [ ] Integrate HealthScoreCard in DashboardPage:
    - Call `useDashboardStats()` hook
    - Pass `healthScore` data to `HealthScoreCard` component
    - Display in dashboard grid layout

- [ ] **Task 3: Implement Meeting Pipeline Kanban board** (AC: 3)
  - [ ] Create component: `apps/web/src/components/organisms/PipelineKanban.tsx`
  - [ ] Define props interface:
    ```typescript
    interface PipelineKanbanProps {
      stages: {
        id: string;
        label: string;
        prospects: ProspectCard[];
        count: number;
      }[];
      onProspectMove?: (prospectId: string, newStage: string) => void;
      isDragEnabled?: boolean;
    }
    ```
  - [ ] Implement Kanban layout:
    - 4 columns: "Contacted", "Engaged", "Qualified", "Meeting Booked"
    - Column headers: Stage label + count badge (e.g., "Engaged (12)")
    - Horizontal scroll on smaller screens (mobile)
    - Equal width columns on desktop
  - [ ] Create ProspectCard component: `apps/web/src/components/molecules/ProspectCard.tsx`
    - Display: Name, company, avatar (if available)
    - VIP indicator: Gold crown icon (ðŸ‘‘) if `isVIP = true`
    - Confidence score badge: Color-coded (green if >80, amber if <80)
    - Last activity: "2 hours ago" format
    - Hover: Shadow-md, border-primary-blue-300
  - [ ] Fetch pipeline data:
    - Create API hook: `apps/web/src/hooks/usePipeline.ts`
    - Fetch from API: `GET /api/dashboard/pipeline`
    - Group prospects by status: `contacted`, `engaged`, `qualified`, `meeting_booked`
    - Return: `{ contacted: Prospect[], engaged: Prospect[], qualified: Prospect[], meetingBooked: Prospect[] }`
  - [ ] Implement drag-drop (optional for MVP):
    - Use `@dnd-kit/core` library (if drag-drop enabled)
    - Visual feedback: Shadow + opacity on drag
    - Call `onProspectMove` callback on drop
    - Update prospect status via API: `PATCH /api/prospects/:id` with `{ status: newStage }`
  - [ ] Integrate PipelineKanban in DashboardPage:
    - Call `usePipeline()` hook
    - Pass pipeline data to `PipelineKanban` component
    - Display in dashboard grid layout

- [ ] **Task 4: Implement AI Activity Stream with Supabase Realtime** (AC: 4)
  - [ ] **Note:** Component already exists at `apps/web/src/components/AIActivityStream.tsx` - Review and enhance if needed
  - [ ] Verify component props:
    - `activities: ActivityItem[]`
    - `maxHeight?: string` (default: "400px")
    - `enableLiveUpdates?: boolean` (default: false)
  - [ ] Enhance component with Supabase Realtime:
    - Create hook: `apps/web/src/hooks/useActivityStream.ts`
    - Initialize Supabase client: `const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)`
    - Subscribe to `ai_conversation_log` table:
      ```typescript
      const channel = supabase
        .channel('ai-activity')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'ai_conversation_log',
          filter: `user_id=eq.${userId}`
        }, (payload) => {
          // Add new activity to stream
          setActivities(prev => [formatActivity(payload.new), ...prev.slice(0, 49)]);
        })
        .subscribe();
      ```
    - Format activity items:
      - Extract: `prospect_name`, `action_type`, `confidence_score`, `timestamp`
      - Format message: "AI qualified [Sarah Chen] - Confidence: 92%"
      - Return: `ActivityItem` with `id`, `timestamp`, `message`, `type`, `confidenceScore`
    - Cleanup subscription on unmount: `channel.unsubscribe()`
  - [ ] Implement activity stream UI:
    - Scrollable container with max-height
    - New items insert at top with fade-in animation (200ms)
    - Highlight new items: Yellow background for 2s, then fade to white
    - Max 50 items in DOM (remove older items)
    - Live indicator: Green pulsing dot + "Live" text when `enableLiveUpdates = true`
  - [ ] Fetch initial activities:
    - Create API hook: `apps/web/src/hooks/useActivityStream.ts`
    - Fetch from API: `GET /api/dashboard/activity-stream?limit=20`
    - Merge with Realtime updates
  - [ ] Integrate AIActivityStream in DashboardPage:
    - Call `useActivityStream()` hook with `enableLiveUpdates={true}`
    - Pass activities to `AIActivityStream` component
    - Display in dashboard grid layout

- [ ] **Task 5: Implement Alert Center** (AC: 5)
  - [ ] Create component: `apps/web/src/components/organisms/AlertCenter.tsx`
  - [ ] Define alert types:
    ```typescript
    interface Alert {
      id: string;
      type: 'deliverability' | 'vip_review' | 'meeting_booked' | 'warning' | 'info';
      title: string;
      message: string;
      timestamp: Date;
      actionUrl?: string; // e.g., "/review-queue" for VIP reviews
      severity: 'high' | 'medium' | 'low';
    }
    ```
  - [ ] Fetch alerts from API:
    - Create API hook: `apps/web/src/hooks/useAlerts.ts`
    - Fetch from API: `GET /api/dashboard/alerts`
    - Filter by severity: Show high/medium by default, low on expand
    - Return: `Alert[]`
  - [ ] Implement alert display:
    - Card layout with icon per alert type:
      - Deliverability: Red alert icon (bounce rate >5% or spam >0.1%)
      - VIP review: Yellow alert icon (VIP accounts needing review)
      - Meeting booked: Green success icon (new meeting booked)
      - Warning: Amber warning icon (general warnings)
      - Info: Blue info icon (informational)
    - Timestamp: "2 hours ago" format
    - Action button: "View Details" or "Review Now" (if `actionUrl` provided)
    - Dismissible: X button to dismiss alert (call API: `POST /api/dashboard/alerts/:id/dismiss`)
  - [ ] Implement alert badge count:
    - Create component: `apps/web/src/components/atoms/AlertBadge.tsx`
    - Display in dashboard header/navigation
    - Show count of unread alerts (high + medium severity)
    - Click to scroll to Alert Center or navigate to alerts page
  - [ ] Integrate AlertCenter in DashboardPage:
    - Call `useAlerts()` hook
    - Pass alerts to `AlertCenter` component
    - Display in dashboard grid layout (top section)

- [ ] **Task 6: Implement mobile responsive layout** (AC: 6)
  - [ ] Update DashboardLayout:
    - Use Tailwind responsive classes:
      - Desktop: `grid-cols-3` (3 columns)
      - Tablet: `grid-cols-2` (2 columns)
      - Mobile: `grid-cols-1` (1 column, stacked)
    - Hide sidebar on mobile: `hidden md:block`
    - Collapsible navigation menu on mobile
  - [ ] Update HealthScoreCard:
    - Mobile: Smaller circular progress (80px instead of 120px)
    - Stack breakdown vertically on mobile
  - [ ] Update PipelineKanban:
    - Mobile: Horizontal scroll for columns
    - Cards: Full width on mobile, reduced padding
    - Disable drag-drop on mobile (touch conflicts)
  - [ ] Update AIActivityStream:
    - Mobile: Reduced max-height (300px instead of 400px)
    - Compact activity items (smaller font, less padding)
  - [ ] Update AlertCenter:
    - Mobile: Stack alerts vertically
    - Compact alert cards (smaller icons, condensed text)
  - [ ] Test responsive breakpoints:
    - Mobile: < 640px (sm)
    - Tablet: 640px - 1024px (md)
    - Desktop: > 1024px (lg)

- [ ] **Task 7: Create dashboard API integration** (AC: 1, 2, 3, 4, 5)
  - [ ] **Note:** DashboardService already exists at `apps/api/src/services/DashboardService.ts` - Verify endpoints exist
  - [ ] Verify API endpoint: `GET /api/dashboard/stats`
    - Location: `apps/api/src/routes/dashboard.ts` (or create if doesn't exist)
    - Call: `DashboardService.getStats(userId)`
    - Return: `{ success: true, data: { healthScore, pipeline, pendingReviews, ... } }`
  - [ ] Verify API endpoint: `GET /api/dashboard/pipeline`
    - Call: `DashboardService.getPipeline(userId)` (or extend getStats)
    - Return: `{ success: true, data: { contacted: Prospect[], engaged: Prospect[], qualified: Prospect[], meetingBooked: Prospect[] } }`
  - [ ] Verify API endpoint: `GET /api/dashboard/activity-stream`
    - Call: `DashboardService.getActivityStream(userId, limit)`
    - Return: `{ success: true, data: ActivityStreamItem[] }`
  - [ ] Create API endpoint: `GET /api/dashboard/alerts` (if doesn't exist)
    - Location: `apps/api/src/routes/dashboard.ts`
    - Query alerts:
      - Deliverability: Check bounce rate >5% or spam >0.1% from campaigns
      - VIP reviews: Count pending VIP reviews from `ai_review_queue` JOIN `prospects` WHERE `is_vip = true`
      - Meetings booked: Recent meetings (last 24 hours) from `meetings` table
    - Return: `{ success: true, data: Alert[] }`
  - [ ] Create API endpoint: `POST /api/dashboard/alerts/:id/dismiss`
    - Store dismissed alerts in `user_dismissed_alerts` table or session storage
    - Return: `{ success: true }`
  - [ ] Add authentication middleware to all dashboard endpoints
  - [ ] Create API client: `apps/web/src/lib/api-client.ts`
    - Configure Axios with base URL: `import.meta.env.VITE_API_URL`
    - Add auth interceptor: Include JWT token from Supabase session
    - Handle errors: 401 â†’ redirect to login, 403 â†’ show error message

- [ ] **Task 8: Install and configure shadcn/ui components** (AC: 1)
  - [ ] Install shadcn/ui CLI: `npm install -D shadcn-ui@latest`
  - [ ] Initialize shadcn/ui: `npx shadcn-ui@latest init`
    - Configure: TypeScript, Tailwind CSS, src directory
  - [ ] Install required components:
    ```bash
    npx shadcn-ui@latest add card
    npx shadcn-ui@latest add badge
    npx shadcn-ui@latest add button
    npx shadcn-ui@latest add alert
    npx shadcn-ui@latest add avatar
    npx shadcn-ui@latest add progress
    npx shadcn-ui@latest add separator
    npx shadcn-ui@latest add toast
    ```
  - [ ] Verify components installed in: `apps/web/src/components/ui/`
  - [ ] Configure Tailwind CSS: `apps/web/tailwind.config.js`
    - Ensure shadcn/ui theme colors are configured
    - Add custom colors if needed (primary-blue, success-green, etc.)

- [ ] **Task 9: Set up Supabase client for frontend** (AC: 4, 7)
  - [ ] Install Supabase client: `npm install @supabase/supabase-js`
  - [ ] Create Supabase client: `apps/web/src/lib/supabase.ts`
    ```typescript
    import { createClient } from '@supabase/supabase-js';
    
    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
    
    export const supabase = createClient(supabaseUrl, supabaseAnonKey);
    ```
  - [ ] Configure environment variables: `apps/web/.env.example`
    - `VITE_SUPABASE_URL=https://xxx.supabase.co`
    - `VITE_SUPABASE_ANON_KEY=xxx`
    - `VITE_API_URL=https://api.example.com`
  - [ ] Create auth store: `apps/web/src/stores/auth.store.ts`
    - Use Zustand: `create<AuthState>((set) => ({ ... }))`
    - Store: `user`, `session`, `login()`, `logout()`
    - Persist session: Check on app load, restore from localStorage if available

- [ ] **Task 10: Write unit tests** (AC: All)
  - [ ] Create test: `apps/web/tests/unit/components/HealthScoreCard.test.tsx`
    - Test score display (0-100)
    - Test color coding (green/amber/red)
    - Test trend indicator
    - Test breakdown expansion
  - [ ] Create test: `apps/web/tests/unit/components/PipelineKanban.test.tsx`
    - Test column rendering
    - Test prospect card display
    - Test drag-drop (if enabled)
  - [ ] Create test: `apps/web/tests/unit/components/AIActivityStream.test.tsx`
    - Test activity rendering
    - Test Realtime subscription (mock)
    - Test new activity animation
  - [ ] Create test: `apps/web/tests/unit/hooks/useDashboardStats.test.ts`
    - Test API call
    - Test data transformation
    - Test error handling
  - [ ] Create test: `apps/web/tests/unit/hooks/useActivityStream.test.ts`
    - Test Supabase Realtime subscription
    - Test activity formatting
    - Test cleanup on unmount

## Dev Notes

### Architecture Context

**Dashboard Frontend:**
- React SPA with TypeScript, Tailwind CSS, shadcn/ui components
- Zustand for state management, Supabase Realtime for live updates
- Protected routes with authentication check
- Mobile-responsive layout with Tailwind breakpoints

**Integration with Story 1.8:**
- Uses DashboardService from backend (Story 1.8)
- Health score calculation: `calculate_health_score()` database function
- Metrics API endpoints: `/api/dashboard/stats`, `/api/dashboard/pipeline`, `/api/dashboard/activity-stream`

**Integration with Story 2.1:**
- Displays confidence scores in pipeline cards and activity stream
- VIP indicators for high-value accounts

**Integration with Story 1.7:**
- Displays meetings in pipeline ("Meeting Booked" column)
- Meeting booked alerts in Alert Center

**Previous Story Insights:**
From Story 1.8: DashboardService exists at `apps/api/src/services/DashboardService.ts` with `getStats()` and `getActivityStream()` methods. Health score calculated via `calculate_health_score()` database function. Metrics endpoints exist.

From Story 1.1: Supabase client setup exists. Authentication infrastructure in place.

**Component Library:**
- HealthScoreCard: Circular progress with color coding, trend indicator, expandable breakdown
- PipelineKanban: 4-column Kanban board with prospect cards
- AIActivityStream: Real-time feed with Supabase Realtime subscription
- AlertCenter: Alert notifications with severity levels

**Supabase Realtime:**
- Subscribe to `ai_conversation_log` table for INSERT events
- Filter by `user_id` for multi-tenant isolation
- Format activities: "AI qualified [Sarah Chen] - Confidence: 92%"
- Max 50 items in DOM, remove older items

**Mobile Responsive:**
- Breakpoints: sm (<640px), md (640-1024px), lg (>1024px)
- Stack layout on mobile, grid on desktop
- Horizontal scroll for Kanban on mobile
- Compact components on mobile

**File Locations:**
- Pages: `apps/web/src/pages/DashboardPage.tsx`
- Components: `apps/web/src/components/organisms/`, `apps/web/src/components/molecules/`, `apps/web/src/components/atoms/`
- Hooks: `apps/web/src/hooks/useDashboardStats.ts`, `usePipeline.ts`, `useActivityStream.ts`, `useAlerts.ts`
- Stores: `apps/web/src/stores/auth.store.ts`
- API Client: `apps/web/src/lib/api-client.ts`
- Supabase Client: `apps/web/src/lib/supabase.ts`

### Testing

**Testing Framework:** Vitest + React Testing Library for component tests, Playwright for E2E tests

**Test Organization:**
- Component tests: `apps/web/tests/unit/components/*.test.tsx`
- Hook tests: `apps/web/tests/unit/hooks/*.test.ts`
- E2E tests: `apps/web/tests/e2e/dashboard.spec.ts`

**Test Requirements:**
1. Test HealthScoreCard: Score display, color coding, trend, breakdown
2. Test PipelineKanban: Column rendering, prospect cards, drag-drop
3. Test AIActivityStream: Activity rendering, Realtime subscription, animations
4. Test AlertCenter: Alert display, severity levels, dismiss functionality
5. Test authentication: Protected routes, session validation, redirect to login
6. Test mobile responsive: Layout changes at breakpoints, horizontal scroll
7. Test API integration: Data fetching, error handling, loading states
8. Test Supabase Realtime: Subscription setup, activity updates, cleanup

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | Initial story creation for Epic 5: Zero-Config Onboarding & Dashboard UX | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
TBD

### Completion Notes
- Story created as part of Epic 5: Zero-Config Onboarding & Dashboard UX
- Implements React dashboard with health score, pipeline, activity stream, and alerts
- Integrates with Supabase Realtime for live updates
- Mobile-responsive layout with Tailwind CSS breakpoints
- Uses shadcn/ui components for consistent UI

